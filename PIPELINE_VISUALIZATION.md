# 研究Pipeline可视化流程

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        输入数据层 (Input Data)                        │
├─────────────────────────────────────────────────────────────────────┤
│  • ESA-CCI土地覆盖 (1992-2022)  • OSM/CNN光伏站点                     │
│  • 15维环境特征 (NetCDF)        • AR6政策情景数据                     │
│  • 碳汇数据 (AGB/BGB/SOC)       • 美国州界shapefile                   │
└───────────────────┬─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   阶段一: 数据预处理与对齐                            │
│                  (Notebooks: 0.0, 2.1, 2.2, 2.3)                    │
├─────────────────────────────────────────────────────────────────────┤
│  1. 废弃农田识别 (5年移动窗口)                                        │
│     输出: 4.7 Mha废弃农田点位                                        │
│                                                                       │
│  2. 空间网格对齐 (1/120° ~1km)                                       │
│     工具: align.py, raster_process.ipynb                             │
│     输出: 统一坐标系的NetCDF数据集                                    │
│                                                                       │
│  3. 特征提取与嵌入                                                    │
│     • 物理地理: DEM, 坡度, 土地覆盖, 生物量                           │
│     • 气候: 气温, 风速, 太阳辐射                                      │
│     • 社会经济: 人口, GDP, 距离特征, 道路密度                         │
│     输出: 特征矩阵 [N × 15]                                          │
└───────────────────┬─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│          阶段二: 环境适宜性建模 (两阶段机器学习)                       │
│                  (Notebook: 3.0 pre-training.ipynb)                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │  Stage 1: GMM环境结构识别                                 │       │
│  │  (function/gmm_training.py)                              │       │
│  ├──────────────────────────────────────────────────────────┤       │
│  │  • 输入: 光伏正样本特征 [M × 15]                          │       │
│  │  • 模型: 23组件GMM (BIC准则)                             │       │
│  │  • 聚类: Ward层次聚类 → 3个环境原型                      │       │
│  │    - Cluster 1 (38.9%): 社会经济活跃区                  │       │
│  │    - Cluster 2 (8.2%): 山区生物量丰富区                 │       │
│  │    - Cluster 3 (52.9%): 中西部平坦区                    │       │
│  │  • 输出: 环境对数密度得分                                │       │
│  └─────────────┬────────────────────────────────────────────┘       │
│                │                                                     │
│                ▼                                                     │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │  负样本生成 (function/negative_sampling.py)              │       │
│  ├──────────────────────────────────────────────────────────┤       │
│  │  • 策略: 从GMM低密度区域(5th百分位)采样                  │       │
│  │  • 比例: 正负1:1                                         │       │
│  │  • 难度: 分层采样(简单/中等/困难)                        │       │
│  │  • 输出: 平衡训练集                                      │       │
│  └─────────────┬────────────────────────────────────────────┘       │
│                │                                                     │
│                ▼                                                     │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │  Stage 2: Transformer-ResNet分类器                       │       │
│  │  (function/model_building.py + pipeline.py)             │       │
│  ├──────────────────────────────────────────────────────────┤       │
│  │                                                           │       │
│  │    [输入层]                                               │       │
│  │       │                                                  │       │
│  │       ├─────────────┬─────────────────┐                 │       │
│  │       │             │                 │                 │       │
│  │  [Transformer]  [ResNet]              │                 │       │
│  │    • Reshape     • BN                 │                 │       │
│  │    • MultiHead   • Dense+Residual     │                 │       │
│  │      Attention   • Add+Activation     │                 │       │
│  │    • FFN         • Dropout            │                 │       │
│  │    • GlobalPool                       │                 │       │
│  │       │             │                 │                 │       │
│  │       └──────┬──────┘                 │                 │       │
│  │              │                        │                 │       │
│  │         [Fusion Layer]                │                 │       │
│  │              │                        │                 │       │
│  │         [Sigmoid(0-1)]                │                 │       │
│  │                                       │                 │       │
│  │  • 性能: Acc=0.89, F1=0.90            │                 │       │
│  │  • 输出: 部署概率地图                  │                 │       │
│  └───────────────────────────────────────┘                 │       │
│                                                             │       │
└───────────────────┬─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│           阶段三: 碳减排潜力评估 (Emission Mitigation)                │
│             (Notebook: 4.1 Emission_reduction_potential.ipynb)     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌────────────────────────────────────────────┐                      │
│  │  光伏减排潜力计算                           │                      │
│  ├────────────────────────────────────────────┤                      │
│  │  [太阳辐射] → [温度修正] → [发电量]         │                      │
│  │     CHELSA      T_cell      PV_generation  │                      │
│  │                                             │                      │
│  │  [电网替代] → [碳减排]                      │                      │
│  │   IFI+IEA      CO₂减排                      │                      │
│  │                                             │                      │
│  │  • 参数: 0.17kW/m², η=0.8, 8760h/年        │                      │
│  │  • 周期: 30年 (2020-2050)                  │                      │
│  │  • 结果: 62.83±17.05 Gt CO₂                │                      │
│  └────────────────────────────────────────────┘                      │
│                                                                       │
│  ┌────────────────────────────────────────────┐                      │
│  │  LNCS碳汇潜力评估                           │                      │
│  ├────────────────────────────────────────────┤                      │
│  │  三种策略:                                  │                      │
│  │  • 造林 (F): AGB+BGB+SOC+枯枝落叶          │                      │
│  │  • 农业 (A): 主要SOC变化                   │                      │
│  │  • 非木本植被 (N): BGB+SOC                 │                      │
│  │                                             │                      │
│  │  概率分配: K-d树 + IDW                     │                      │
│  │  结果: 3.91 Gt CO₂                         │                      │
│  └────────────────────────────────────────────┘                      │
│                                                                       │
│  净减排 = 光伏减排 - LNCS机会 = 58.92±17.05 Gt CO₂                  │
│          (占1.5°C碳预算的23.5%)                                       │
└───────────────────┬─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│           阶段四: 经济可行性分析 (Economic Viability)                 │
│                  (Notebook: 5.1 Economical_feasibility.ipynb)      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌─────────────────────────────────────────────────────────┐        │
│  │  光伏NPV计算 (IPCC AR6情景)                              │        │
│  ├─────────────────────────────────────────────────────────┤        │
│  │  政策情景矩阵:                                           │        │
│  │  • P1: 无全球协调                                       │        │
│  │  • P2: 立即行动 (P2a/b/c)                              │        │
│  │  • P3: 延迟行动 (P3a/b/c)                              │        │
│  │                                                          │        │
│  │  NPV = Σ(收入 - 运营成本 - 投资) - LNCS机会成本          │        │
│  │                                                          │        │
│  │  参数: 贴现率5%, 2020-2050, 2020年美元不变价             │        │
│  │  结果: -1,266 to +1,664 k USD/ha                        │        │
│  └─────────────────────────────────────────────────────────┘        │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────┐        │
│  │  LNCS机会成本                                            │        │
│  ├─────────────────────────────────────────────────────────┤        │
│  │  • 造林: AGB→木材产品 + 实施成本                         │        │
│  │  • 农业: FAO价格 × GAEZ产量 (184作物)                   │        │
│  │  • 非木本: 自然再生成本                                  │        │
│  │                                                          │        │
│  │  结果: LNCS成本 < 1 kUSD/ha (远低于光伏)                 │        │
│  └─────────────────────────────────────────────────────────┘        │
│                                                                       │
└───────────────────┬─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│         阶段五: 3E协同分析 (3E-Synergy Framework)                     │
│                  (Notebook: 6.4 3E_synergy_index.ipynb)            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌────────────────────────────────────────────────┐                 │
│  │  3E指标体系                                     │                 │
│  ├────────────────────────────────────────────────┤                 │
│  │  [E1: Environment]  部署概率 (0-1)             │                 │
│  │       来自: Transformer-ResNet                 │                 │
│  │                                                 │                 │
│  │  [E2: Emission]  净减排 (t CO₂/ha)            │                 │
│  │       来自: 光伏减排 - LNCS机会                │                 │
│  │                                                 │                 │
│  │  [E3: Economic]  平均NPV (k USD/ha)            │                 │
│  │       来自: AR6多情景均值                       │                 │
│  └────────────────────────────────────────────────┘                 │
│                                                                       │
│  ┌────────────────────────────────────────────────┐                 │
│  │  3E-Synergy指数计算 (WCCD)                     │                 │
│  ├────────────────────────────────────────────────┤                 │
│  │  耦合度 C = (∏U_i / (⅓∑U_i)³)^(1/3)           │                 │
│  │  协调度 T = Σw_i × U_i                        │                 │
│  │  协同指数 = √(C × T)                           │                 │
│  │                                                 │                 │
│  │  优化: SLSQP算法寻找最优权重w_i                │                 │
│  │  约束: Σw_i=1, w_i≥0                           │                 │
│  └────────────────────────────────────────────────┘                 │
│                                                                       │
│  ┌────────────────────────────────────────────────┐                 │
│  │  政策优先级排序                                │                 │
│  ├────────────────────────────────────────────────┤                 │
│  │  决策策略对比:                                 │                 │
│  │  • 环境最优 (E1 max)                          │                 │
│  │  • 减排最优 (E2 max)                          │                 │
│  │  • 经济最优 (E3 max)                          │                 │
│  │  • 3E协同 (Synergy max) ⭐推荐                │                 │
│  │                                                 │                 │
│  │  E_k(π) = ∫₀¹ g_k(π(u)) × w(u) du            │                 │
│  │  • π: 优先级序列                              │                 │
│  │  • g_k: 边际收益函数                          │                 │
│  │  • w(u): 分位数注意力核                       │                 │
│  └────────────────────────────────────────────────┘                 │
│                                                                       │
│  性能提升(相比单一准则):                                              │
│  • 环境: +6.9%  • 减排: +2.8%  • 经济: +629%  • 综合: +38.4%       │
└───────────────────┬─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│    阶段六: 可视化与多尺度分析 (Visualization & Multi-scale)           │
│              (Notebooks: 6.1, 6.5-6.9, 7.0-7.3, 8.0, 9.0)          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌────────────────────────────────────────────────┐                 │
│  │  探索性数据分析 (6.1 EDA_data.ipynb)          │                 │
│  ├────────────────────────────────────────────────┤                 │
│  │  • 数据分布特征                               │                 │
│  │  • 相关性矩阵                                 │                 │
│  │  • 异常值检测                                 │                 │
│  └────────────────────────────────────────────────┘                 │
│                                                                       │
│  ┌────────────────────────────────────────────────┐                 │
│  │  可视化模块 (6.5-6.9)                         │                 │
│  ├────────────────────────────────────────────────┤                 │
│  │  • 6.6: Figure 1 - 环境适宜性空间分布         │                 │
│  │  • 6.7: Figure 2 - 政策情景矩阵              │                 │
│  │  • 6.5: Figure 2 - 优先级地图                │                 │
│  │  • 6.8: Figure 3 - 光伏vs LNCS碳减排对比     │                 │
│  │  • 6.9: Figure 4 - 累积收益曲线              │                 │
│  └────────────────────────────────────────────────┘                 │
│                                                                       │
│  ┌────────────────────────────────────────────────┐                 │
│  │  国家层面分析 (7.0)                            │                 │
│  ├────────────────────────────────────────────────┤                 │
│  │  • 仅需10%高优先级地块 → 2050年30%太阳能目标  │                 │
│  │  • 单一准则缺口: E1(-36.6%), E2(-27.6%)       │                 │
│  │  • 经济变异: -107B to +714B USD               │                 │
│  │  • 累积收益曲线对比                            │                 │
│  └────────────────────────────────────────────────┘                 │
│                                                                       │
│  ┌────────────────────────────────────────────────┐                 │
│  │  州层面分析 (7.1)                              │                 │
│  ├────────────────────────────────────────────────┤                 │
│  │  48个州的3E特征对比:                           │                 │
│  │  • 废弃地面积 (kha)                           │                 │
│  │  • 潜在装机容量 (GW)                          │                 │
│  │  • 3E综合评分                                 │                 │
│  │  • 能源需求满足度 (33州可100%)                │                 │
│  │                                                │                 │
│  │  驱动因子识别 (Mundlak Bayesian):             │                 │
│  │  • 州际: 经济规模(+), 人口(-)                 │                 │
│  │  • 州内: 距城市/基础设施距离(+)               │                 │
│  │  • 稳健: 太阳辐射(两层级均显著)               │                 │
│  └────────────────────────────────────────────────┘                 │
│                                                                       │
│  ┌────────────────────────────────────────────────┐                 │
│  │  多目标优化 (8.0)                             │                 │
│  ├────────────────────────────────────────────────┤                 │
│  │  • Pareto前沿分析                             │                 │
│  │  • 权重敏感性测试                              │                 │
│  │  • 决策空间探索                               │                 │
│  └────────────────────────────────────────────────┘                 │
│                                                                       │
│  ┌────────────────────────────────────────────────┐                 │
│  │  能源需求调整 (9.0)                           │                 │
│  ├────────────────────────────────────────────────┤                 │
│  │  • 未来情景需求预测                            │                 │
│  │  • 州级需求满足度评估                          │                 │
│  │  • 装机容量调整建议                            │                 │
│  └────────────────────────────────────────────────┘                 │
│                                                                       │
│  ┌────────────────────────────────────────────────┐                 │
│  │  附录分析 (7.3, Supplementary/)               │                 │
│  ├────────────────────────────────────────────────┤                 │
│  │  • 7.3: 附录图表                              │                 │
│  │  • S3: 参数敏感性测试                         │                 │
│  │  • S6: 贝叶斯统计推断                         │                 │
│  └────────────────────────────────────────────────┘                 │
│                                                                       │
└───────────────────┬─────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    最终输出 (Final Outputs)                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  📊 可视化成果 (Notebooks 6.5-6.9):                                  │
│  • Figure 1 (6.6): 环境适宜性空间分布与GMM聚类                        │
│  • Figure 2 (6.7+6.5): 政策优先级地图与累积收益曲线                   │
│  • Figure 3 (6.8): 光伏vs LNCS减排对比                               │
│  • Figure 4 (6.9): 单一准则vs 3E协同性能对比                         │
│                                                                       │
│  📈 决策支持工具:                                                     │
│  • 州级优先级排名表 (48个州)                                         │
│  • 3E-synergy空间索引                                                │
│  • 多情景经济可行性矩阵                                               │
│  • 能源需求满足度评估                                                 │
│                                                                       │
│  💾 数据产品:                                                         │
│  • 像元级预测概率地图 (GeoTIFF/NetCDF)                               │
│  • 州级汇总统计表 (CSV)                                              │
│  • 训练好的模型 (GMM.pkl, Transformer.h5)                            │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 关键模块依赖关系

```
Notebook层
│
├── 数据预处理层
│   ├── 0.0 PV_dataset.ipynb           # PV数据质量控制
│   ├── 2.1 process_csv_for_aligning   # 空间网格对齐
│   ├── 2.2 process_csv_for_embedding  # 特征提取
│   └── 2.3 process_csv_for_prediction # 预测数据准备
│
├── 核心计算层 ⭐
│   ├── 3.0 pre-training.ipynb         # 环境适宜性(GMM+Transformer)
│   ├── 4.1 Emission_reduction_potential  # 碳减排潜力
│   ├── 5.1 Economical_feasibility     # 经济可行性
│   └── 6.4 3E_synergy_index           # 3E协同指数
│
├── 可视化层
│   ├── 6.6 Figure1_Enviromental_plot  # Figure 1
│   ├── 6.7 Figure2_Policy_matrix      # Figure 2
│   ├── 6.8 Figure3_Carbon_LNCS        # Figure 3
│   ├── 6.9 Figure4_Cumulative_pirority # Figure 4
│   └── 6.5 Figure2_priority_total     # 优先级地图
│
├── 分析层
│   ├── 6.1 EDA_data                   # 探索性分析
│   ├── 7.0 Analysis_Nation_level      # 国家尺度
│   ├── 7.1 Analysis_State_level       # 州尺度
│   ├── 8.0 Multi-objective            # 多目标优化
│   └── 9.0 Energy_demand_adjust       # 能源需求
│
└── 辅助工具
    ├── 0.0 Check_PV                   # PV数据检查
    ├── Process.ipynb                   # 后处理
    └── raster_process.ipynb           # 栅格工具

function/ 模块层
│
├── pipeline.py ⭐核心流程编排
│   ├── gmm_training.py          # GMM模型训练
│   ├── negative_sampling.py     # 负样本生成
│   ├── model_building.py        # Transformer-ResNet构建
│   ├── training.py              # 模型训练与评估
│   └── evaluation.py            # 性能评估与可视化
│
├── load_ds.py                   # NetCDF数据加载
├── load_pv.py                   # 光伏站点数据加载
├── data_utils.py                # 数据预处理工具
│
├── model_diagnostics.py         # SHAP分析与诊断
├── learning_curve.py            # 学习曲线分析
└── model_saving.py              # 模型保存与加载
```

---

## 数据流转图

```
原始数据
  ├── ESA-CCI Land Cover (1992-2022)
  │     └─> [5年移动窗口] → 废弃农田掩膜
  │
  ├── OSM/CNN PV Sites
  │     └─> [清洗+过滤] → 正样本点位
  │
  ├── 环境特征 (NetCDF)
  │     ├── DEM/Slope
  │     ├── Climate (T/Wind/Radiation)
  │     └── Socioeconomic (Pop/GDP/Roads)
  │           └─> [对齐到1km网格] → 特征矩阵 [N×15]
  │
  ├── AR6 Scenarios
  │     └─> [价格+成本提取] → 经济情景矩阵
  │
  └── Carbon Data
        ├── AGB/BGB Maps
        ├── SOC Potential
        └── GAEZ Yield
              └─> [LNCS潜力计算] → 碳汇评估

中间产物
  ├── GMM Model (23组件)
  │     └─> 环境相似性得分 → 负样本池
  │
  ├── Transformer-ResNet
  │     └─> 部署概率 [0-1] → 环境适宜性地图
  │
  ├── 碳减排计算
  │     ├── 光伏: 62.83 Gt CO₂
  │     └── LNCS: 3.91 Gt CO₂
  │           └─> 净减排: 58.92 Gt CO₂
  │
  └── 经济评估
        ├── 光伏NPV (多情景)
        └── LNCS机会成本
              └─> 经济可行性: -1,266~+1,664 k$/ha

最终产品
  ├── 3E-Synergy Index
  │     ├── 环境维度 (E1)
  │     ├── 减排维度 (E2)
  │     └── 经济维度 (E3)
  │           └─> 优先级排序
  │
  ├── 州级决策矩阵
  │     ├── 48个州的3E评分
  │     ├── 能源需求满足度
  │     └── 驱动因子分析
  │
  └── 可视化成果
        ├── Figure 1-4 (主图)
        └── Supplementary Figures
```

---

## 计算资源需求

| 阶段 | 计算需求 | 预估时间 | 内存需求 |
|------|---------|---------|---------|
| **数据对齐** | CPU密集 | 2-4小时 | 16GB |
| **GMM训练** | CPU | 30-60分钟 | 8GB |
| **Transformer训练** | GPU推荐 | 2-6小时 | 16GB (GPU: 8GB) |
| **预测推断** | GPU/CPU | 1-2小时 | 32GB |
| **碳减排计算** | CPU | 3-5小时 | 16GB |
| **经济分析** | CPU | 2-3小时 | 16GB |
| **协同分析** | CPU | 1-2小时 | 8GB |
| **可视化** | CPU | 30分钟 | 8GB |

**推荐配置**:
- CPU: 16核以上
- GPU: NVIDIA RTX 3080/V100 (可选,用于加速训练)
- RAM: 32GB+
- 存储: 500GB+ (SSD推荐)

---

## 质量控制检查点

### ✅ 阶段一检查
- [ ] 废弃农田数量合理(4-5 Mha范围)
- [ ] 光伏正样本无重复/异常点
- [ ] 特征矩阵无缺失值
- [ ] 所有数据坐标系一致(EPSG:4326)

### ✅ 阶段二检查
- [ ] GMM BIC曲线收敛
- [ ] 负样本分布合理(非全零/全一)
- [ ] 模型F1 > 0.85
- [ ] 学习曲线无严重过拟合

### ✅ 阶段三检查
- [ ] 光伏减排总量在合理范围(50-80 Gt)
- [ ] LNCS概率总和≈1
- [ ] 净减排为正值

### ✅ 阶段四检查
- [ ] NPV分布不全为负
- [ ] LNCS成本 < 光伏成本
- [ ] 多情景结果有差异

### ✅ 阶段五检查
- [ ] 3E-synergy值在0-1之间
- [ ] 优先级地图空间连续性
- [ ] 协同指数 > 单一准则平均值

### ✅ 阶段六检查
- [ ] 州级汇总数值无异常
- [ ] 驱动因子95% CI不全包含0
- [ ] 可视化图表清晰可读

---

## 故障排除指南

### 问题1: NetCDF读取失败
```python
# 解决方案: 使用dask延迟加载
import xarray as xr
ds = xr.open_mfdataset('path/*.nc', chunks={'time': 10})
```

### 问题2: 内存溢出
```python
# 解决方案: 分块处理
for chunk in np.array_split(df, 10):
    process_chunk(chunk)
```

### 问题3: TensorFlow版本冲突
```bash
# 解决方案: 使用兼容版本
pip install tensorflow==2.10.0
```

### 问题4: GDAL依赖问题
```bash
# 解决方案: 使用conda安装
conda install -c conda-forge gdal
```

---

## 性能优化建议

1. **并行化**: 使用`dask`并行处理NetCDF
2. **GPU加速**: Transformer训练使用GPU可提速5-10倍
3. **数据缓存**: 预处理结果缓存到本地
4. **批处理**: 预测时使用batch_size=1024
5. **内存映射**: 大文件使用`np.memmap`

---

**文档版本**: v1.0  
**最后更新**: 2025-01-16
