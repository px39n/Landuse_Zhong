# æ•°æ®æ¥å£ä¸æ•°æ®æµæ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ Global Pipeline çš„ç»Ÿä¸€æ•°æ®æ¥å£è®¾è®¡ï¼ŒåŒ…æ‹¬æ•°æ®è·¯å¾„é…ç½®ã€åŠ è½½å‡½æ•°ã€æ•°æ®æµå‘å’Œä¸åŸæœ‰ä»£ç çš„å¯¹é½æƒ…å†µã€‚

**ç‰ˆæœ¬**: 1.0.0  
**æ›´æ–°æ—¥æœŸ**: 2025-01-16  
**çŠ¶æ€**: âœ… å·²å¯¹é½ `function/global_varibles.py` å’Œ `function/load_all_ds.py`

---

## ğŸ“‹ ç›®å½•

1. [æ•°æ®è·¯å¾„ç»Ÿä¸€](#1-æ•°æ®è·¯å¾„ç»Ÿä¸€)
2. [æ•°æ®åŠ è½½æ¥å£](#2-æ•°æ®åŠ è½½æ¥å£)
3. [æ•°æ®æµå‘å›¾](#3-æ•°æ®æµå‘å›¾)
4. [ä¸åŸä»£ç å¯¹é½](#4-ä¸åŸä»£ç å¯¹é½)
5. [ä½¿ç”¨ç¤ºä¾‹](#5-ä½¿ç”¨ç¤ºä¾‹)
6. [æ•°æ®éªŒè¯](#6-æ•°æ®éªŒè¯)

---

## 1. æ•°æ®è·¯å¾„ç»Ÿä¸€

### 1.1 æ ¸å¿ƒæ¨¡å—

**æ–°æ¨¡å—**: `src/landuse/data/global_paths.py`

**åŠŸèƒ½**:
- ç»Ÿä¸€ç®¡ç†å…¨çƒæ•°æ®è·¯å¾„
- ä¸ `function/global_varibles.py` å®Œå…¨å¯¹é½
- æ”¯æŒä» `configs/global.yaml` åŠ è½½é…ç½®
- æä¾›è·¯å¾„éªŒè¯åŠŸèƒ½

### 1.2 æ•°æ®è·¯å¾„ç±»åˆ«

#### æ ¸å¿ƒæ•°æ®é›†

| æ•°æ®ç±»å‹ | è·¯å¾„é”® | é»˜è®¤è·¯å¾„ | è¯´æ˜ |
|---------|--------|---------|------|
| **Abandonment (NC)** | `abandonment_nc` | `D:\xarray\merged_chunk_2\*.nc` | å…¨çƒé—å¼ƒåœ° NetCDF |
| **Abandonment (CSV)** | `abandonment_csv` | `D:\xarray\03_test\Global_total_2020.csv` | å…¨çƒé—å¼ƒåœ° CSV |
| **Features** | `feature` | `D:/xarray/aligned2/Feature_all/*.nc` | 15 ç»´ç¯å¢ƒç‰¹å¾ |
| **Emission** | `emission` | `D:/xarray/aligned2/Emission_all/*.nc` | æ’æ”¾æ•°æ® |

#### PV æ•°æ®

| æ•°æ®ç±»å‹ | è·¯å¾„é”® | é»˜è®¤è·¯å¾„ | è¯´æ˜ |
|---------|--------|---------|------|
| **PV Sites** | `pv_sites_csv` | `C:\Dev\Landuse_Zhong_clean\data\aligned_for_training0519.csv` | PV ç«™ç‚¹åŸå§‹æ•°æ® |
| **PV Embedding** | `pv_embedding` | `data/pv_global_embedding.csv` | å¯¹é½åçš„ PV + Features |

**ç”Ÿæˆæ–¹å¼**: å‚è€ƒ `2.1 process_csv_for_aligning.ipynb`

```python
# PV Embedding ç”Ÿæˆæµç¨‹
pv_df = load_pv_sites(paths.get('pv_sites_csv'), years=[2018, 2020])
pv_df['lon'] = pv_df['lon'].astype('float32')
pv_df['lat'] = pv_df['lat'].astype('float32')
pv_df = pv_df.rename(columns={'year': 'time'})
pv_df['time'] = pd.to_datetime(pv_df['time'], format='%Y')
# ... align with features ...
pv_df.to_csv(paths.get('pv_embedding'), index=False)
```

#### å…¨çƒçŸ¢é‡è¾¹ç•Œ

| æ•°æ®ç±»å‹ | è·¯å¾„é”® | é»˜è®¤è·¯å¾„ | è¯´æ˜ |
|---------|--------|---------|------|
| **World** | `world_shp` | `world_shp/ne_10m_land.shp` | âœ… **å…¨çƒçŸ¢é‡è¾¹ç•Œ** |
| China | `cn_sheng` | `data/sheng2022.shp` | ä¸­å›½çœçº§è¾¹ç•Œ |
| US | `us_county` | `data/cb_2018_us_county_5m.shp` | ç¾å›½å¿çº§è¾¹ç•Œ |

**é‡è¦**: å…¨çƒåˆ†æä½¿ç”¨ `world_shp`ï¼Œæ›¿ä»£åŸ `PATHS['World_shp']`

#### ç»æµåœºæ™¯æ•°æ®

| åœºæ™¯åç§° | è·¯å¾„é”® | æ–‡ä»¶å |
|---------|--------|--------|
| **Base** | `pv_npv_base` | `5.1_photovoltaic_results_demand_scenario_5.csv` |
| Electrification | `pv_npv_scenarios['electrification']` | `scenario_0.csv` |
| High Growth | `pv_npv_scenarios['high_growth']` | `scenario_1.csv` |
| Low Growth | `pv_npv_scenarios['low_growth']` | `scenario_2.csv` |
| Medium | `pv_npv_scenarios['medium_electrification']` | `scenario_3.csv` |
| Reference | `pv_npv_scenarios['reference']` | `scenario_4.csv` |
| Original | `pv_npv_scenarios['original']` | `complete_streaming.csv` |

### 1.3 é…ç½®æ–‡ä»¶

**è·¯å¾„**: `configs/global.yaml`

```yaml
data:
  # Global data paths (ç»Ÿä¸€å…¨çƒæ•°æ®è·¯å¾„)
  paths:
    # Core datasets
    abandonment_nc: "D:/xarray/merged_chunk_2/*.nc"
    abandonment_csv: "D:/xarray/03_test/Global_total_2020.csv"
    feature: "D:/xarray/aligned2/Feature_all/*.nc"
    emission: "D:/xarray/aligned2/Emission_all/*.nc"
    
    # PV data
    pv_sites_csv: "C:/Dev/Landuse_Zhong_clean/data/aligned_for_training0519.csv"
    pv_embedding: "data/pv_global_embedding.csv"
    
    # Shapefiles (Global)
    world_shp: "world_shp/ne_10m_land.shp"  # âœ… Global vector boundary
    
    # ... more paths ...
```

---

## 2. æ•°æ®åŠ è½½æ¥å£

### 2.1 æ ¸å¿ƒåŠ è½½å‡½æ•°

**æ–°æ¨¡å—**: `src/landuse/data/loaders.py`

#### å‡½æ•°åˆ—è¡¨

| å‡½æ•°å | åŠŸèƒ½ | å¯¹é½åŸå‡½æ•° |
|--------|------|-----------|
| `load_all_ds()` | åŠ è½½ abandonment + features | âœ… `function/load_all_ds.py::load_all_ds()` |
| `load_all_ds_emission()` | åŠ è½½ abandonment + emission | âœ… `function/load_all_ds.py::load_all_ds_emission()` |
| `load_pv_sites()` | åŠ è½½ PV ç«™ç‚¹ CSV | âœ… `function/load_pv.py::load_pv_sites()` |
| `load_pv_embedding()` | åŠ è½½å¯¹é½åçš„ PV+ç‰¹å¾ | âœ… æ–°å¢ï¼ˆåŸºäº 2.1ï¼‰ |
| `load_abandonment_csv()` | åŠ è½½é—å¼ƒåœ° CSV | âœ… æ–°å¢ |
| `load_world_boundaries()` | åŠ è½½å…¨çƒè¾¹ç•Œ | âœ… æ–°å¢ |
| `validate_data_alignment()` | éªŒè¯æ•°æ®å¯¹é½ | âœ… æ–°å¢ |

### 2.2 å‡½æ•°è¯¦è§£

#### `load_all_ds()`

**è¿ç§»è‡ª**: `function/load_all_ds.py::load_all_ds()`

```python
from landuse.data import load_all_ds, get_global_paths

paths = get_global_paths()
ds = load_all_ds(paths, chunks={'lat': 500, 'lon': 500, 'time': 1})

# è¿”å› xarray.Dataset
# - åŒ…å« abandonment + feature å˜é‡
# - åæ ‡è½¬æ¢ä¸º float32
# - 2D å˜é‡æ‰©å±•ä¸º 3D (æ·»åŠ  time ç»´åº¦)
```

**å…³é”®å˜æ›´**:
1. ä½¿ç”¨ `GlobalDataPaths` ç®¡ç†è·¯å¾„
2. è‡ªåŠ¨ä» `configs/global.yaml` è¯»å–é…ç½®
3. ä¿æŒä¸åŸå‡½æ•°å®Œå…¨ç›¸åŒçš„è¾“å‡ºæ ¼å¼

#### `load_pv_sites()`

**è¿ç§»è‡ª**: `function/load_pv.py::load_pv_sites()`

```python
from landuse.data import load_pv_sites

df_pv = load_pv_sites(
    csv_path="path/to/pv.csv",
    years=[2018, 2020]
)

# è¿”å› pandas.DataFrame
# - lon, lat è½¬æ¢ä¸º float32
# - year é‡å‘½åä¸º time å¹¶è½¬æ¢ä¸º datetime64
```

**å¯¹é½ 2.1 notebook**:
```python
# 2.1 process_csv_for_aligning.ipynb
pv_df = load_pv_sites(PATHS['csv'], years=YEARS)
pv_df['lon'] = pv_df['lon'].astype('float32')
pv_df['lat'] = pv_df['lat'].astype('float32')
pv_df = pv_df.rename(columns={'year': 'time'})
pv_df['time'] = pd.to_datetime(pv_df['time'], format='%Y')
```

#### `load_abandonment_csv()`

**æ–°å¢åŠŸèƒ½**: åŠ è½½å…¨çƒé—å¼ƒåœ° CSV

```python
from landuse.data import load_abandonment_csv

df_abandon = load_abandonment_csv()

# è·¯å¾„: D:\xarray\03_test\Global_total_2020.csv
# è‡ªåŠ¨æ ‡å‡†åŒ– lon/lat ä¸º float32
```

#### `load_world_boundaries()`

**æ–°å¢åŠŸèƒ½**: åŠ è½½å…¨çƒçŸ¢é‡è¾¹ç•Œ

```python
from landuse.data import load_world_boundaries
import geopandas as gpd

gdf_world = load_world_boundaries()

# è¿”å› GeoDataFrame
# è·¯å¾„: world_shp/ne_10m_land.shp (Natural Earth 10m land)
```

### 2.3 å˜é‡å®šä¹‰

#### Feature Variables

```python
from landuse.data import get_all_feature_variables

features = get_all_feature_variables()
# ['GDPpc', 'GDPtot', 'GURdist', 'Population',
#  'gdmp', 'rsds', 'tas', 'wind',  # 3D (time-varying)
#  'DEM', 'Powerdist', 'PrimaryRoad', 'SecondaryRoad',
#  'TertiaryRoad', 'Slope']  # 2D (static)
```

#### Abandonment Variables

```python
from landuse.data import get_all_abandonment_variables

abandon_vars = get_all_abandonment_variables()
# ['current_abandonment', 'recultivation',
#  'abandonment_duration', 'abandonment_year']
```

#### Numeric Features (for ML)

```python
from landuse.data import get_numeric_features

numeric_features = get_numeric_features()
# ['lat', 'lon', 'GDPpc', 'GDPtot', 'GURdist', 'DEM', 'Slope',
#  'Population', 'Powerdist', 'PrimaryRoad', 'SecondaryRoad',
#  'TertiaryRoad', 'gdmp', 'rsds', 'tas', 'wind']
```

---

## 3. æ•°æ®æµå‘å›¾

### 3.1 Overall Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Global Pipeline Data Flow                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    configs/global.yaml
                            â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   GlobalDataPaths           â”‚
              â”‚   (src/landuse/data/)       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ loaders â”‚       â”‚   catalog   â”‚     â”‚ manifest â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Pipeline      â”‚
                    â”‚ Stages 0-9    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Stage-by-Stage Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 0: Data Ingestion                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Input:
  â”œâ”€ abandonment_csv: Global_total_2020.csv
  â”œâ”€ pv_sites_csv: aligned_for_training0519.csv
  â””â”€ world_shp: ne_10m_land.shp

Functions:
  â”œâ”€ load_abandonment_csv()
  â”œâ”€ load_pv_sites()
  â””â”€ load_world_boundaries()

Output:
  â””â”€ Validated DataFrame + GeoDataFrame

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: Spatial Alignment                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Input:
  â”œâ”€ abandonment_nc: D:\xarray\merged_chunk_2\*.nc
  â”œâ”€ feature: D:/xarray/aligned2/Feature_all/*.nc
  â””â”€ pv_sites from Stage 0

Functions:
  â”œâ”€ load_all_ds()
  â””â”€ Align PV sites to 1/120Â° grid

Output:
  â””â”€ pv_embedding: pv_global_embedding.csv
     (PV sites + 15 features aligned)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 2-3: Feature Extraction & Prediction Prep          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Input:
  â””â”€ pv_embedding from Stage 1

Functions:
  â”œâ”€ Extract 15-dim features
  â””â”€ Prepare train/val/test datasets

Output:
  â””â”€ Training-ready datasets

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 4-5: Model Training                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Input:
  â””â”€ Training datasets from Stage 2-3

Functions:
  â”œâ”€ GMM training
  â”œâ”€ Negative sampling
  â””â”€ Transformer-ResNet training

Output:
  â””â”€ Trained models + Predictions

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 6-8: 3E Analysis                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Input:
  â”œâ”€ Predictions from Stage 5
  â”œâ”€ emission: D:/xarray/aligned2/Emission_all/*.nc
  â””â”€ pv_npv_scenarios from config

Functions:
  â”œâ”€ Carbon benefit calculation
  â”œâ”€ Economic NPV calculation
  â””â”€ 3E-Synergy index (WCCD)

Output:
  â””â”€ Priority rankings

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 9: Visualization                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Input:
  â”œâ”€ Priority rankings from Stage 8
  â””â”€ world_shp from config

Functions:
  â””â”€ Generate publication figures

Output:
  â””â”€ Figure 1-4 (PDF/PNG)
```

---

## 4. ä¸åŸä»£ç å¯¹é½

### 4.1 Path Alignment

#### âœ… å®Œå…¨å¯¹é½

| åŸè·¯å¾„ï¼ˆ`function/global_varibles.py`ï¼‰ | æ–°è·¯å¾„ï¼ˆ`GlobalDataPaths`ï¼‰ | çŠ¶æ€ |
|----------------------------------------|---------------------------|------|
| `PATHS['abandonment']` | `paths.get('abandonment_nc')` | âœ… å¯¹é½ |
| `PATHS['feature']` | `paths.get('feature')` | âœ… å¯¹é½ |
| `PATHS['csv']` | `paths.get('pv_sites_csv')` | âœ… å¯¹é½ |
| `PATHS['World_shp']` | `paths.get('world_shp')` | âœ… å¯¹é½ |
| `PATHS['us_pv_embedding']` | `paths.get('pv_embedding')` | âœ… å¯¹é½ |

#### ğŸ”„ è·¯å¾„å˜æ›´

| åŸè·¯å¾„ | æ–°è·¯å¾„ | å˜æ›´åŸå›  |
|--------|--------|---------|
| US-specific paths | Excluded | å…¨çƒ pipeline ä¸éœ€è¦ |
| `abandonment_csv` (æ–°å¢) | `D:\xarray\03_test\Global_total_2020.csv` | æ–°å¢å…¨çƒ CSV æ•°æ®æº |

### 4.2 Variable Alignment

#### âœ… å®Œå…¨ä¸€è‡´

```python
# Original: function/global_varibles.py
abandon_2d_variable = [
    "current_abandonment", "recultivation",
    "abandonment_duration", "abandonment_year"
]

# New: GlobalDataPaths.ABANDON_2D_VARIABLES
# å®Œå…¨ç›¸åŒ
```

```python
# Original: function/global_varibles.py
fea_3d_variable = [
    'GDPpc', 'GDPtot', 'GURdist', 'Population',
    'gdmp', 'rsds', 'tas', 'wind'
]

# New: GlobalDataPaths.FEATURE_3D_VARIABLES
# å®Œå…¨ç›¸åŒ
```

```python
# Original: function/global_varibles.py
NUMERIC_FEATURES = [
    'lat','lon','GDPpc', 'GDPtot', 'GURdist', 'DEM','Slope',
    'Population','Powerdist','PrimaryRoad','SecondaryRoad','TertiaryRoad',
    'gdmp','rsds','tas','wind'
]

# New: GlobalDataPaths.NUMERIC_FEATURES
# å®Œå…¨ç›¸åŒ
```

### 4.3 Function Alignment

#### `load_all_ds()` å¯¹æ¯”

**Original** (`function/load_all_ds.py`):
```python
def load_all_ds():
    ds_abandon, ds_feat = load_datasets(
        PATHS['abandonment'], PATHS['feature'])
    ds_merge = xr.merge([ds_abandon, ds_feat])
    ds_merge = ds_merge.assign_coords({
        'lon': ds_merge.lon.astype('float32'),
        'lat': ds_merge.lat.astype('float32')
    })
    for var in ds_merge.data_vars:
        if 'time' not in ds_merge[var].dims:
            ds_merge[var] = ds_merge[var].expand_dims(time=ds_merge.time)
    return ds_merge
```

**New** (`src/landuse/data/loaders.py`):
```python
def load_all_ds(paths=None, chunks=None):
    if paths is None:
        paths = get_global_paths()
    ds_abandon, ds_feat = load_datasets(
        paths.get('abandonment_nc'),
        paths.get('feature'),
        chunks
    )
    ds_merge = xr.merge([ds_abandon, ds_feat])
    ds_merge = ds_merge.assign_coords({
        'lon': ds_merge.lon.astype('float32'),
        'lat': ds_merge.lat.astype('float32')
    })
    for var in ds_merge.data_vars:
        if 'time' not in ds_merge[var].dims:
            ds_merge[var] = ds_merge[var].expand_dims(time=ds_merge.time)
    return ds_merge
```

**å˜æ›´**:
- âœ… æ ¸å¿ƒé€»è¾‘å®Œå…¨ç›¸åŒ
- âœ… æ·»åŠ  `paths` å‚æ•°ï¼ˆå‘åå…¼å®¹ï¼‰
- âœ… æ·»åŠ  `chunks` å‚æ•°ï¼ˆå¯é€‰ï¼‰
- âœ… ä½¿ç”¨ `GlobalDataPaths` ç®¡ç†è·¯å¾„

---

## 5. ä½¿ç”¨ç¤ºä¾‹

### 5.1 åŸºç¡€ä½¿ç”¨

```python
from landuse.data import get_global_paths, load_all_ds

# 1. è·å–è·¯å¾„é…ç½®
paths = get_global_paths()

# 2. åŠ è½½æ•°æ®
ds = load_all_ds(paths)

print(f"Loaded {ds.dims}")
# Output: Loaded {'lat': 21600, 'lon': 43200, 'time': 2}
```

### 5.2 ä»é…ç½®æ–‡ä»¶åŠ è½½

```python
from landuse.data import GlobalDataPaths
import yaml

# 1. ä» YAML åŠ è½½é…ç½®
with open('configs/global.yaml', 'r') as f:
    config = yaml.safe_load(f)

paths = GlobalDataPaths(config)

# 2. è·å–ç‰¹å®šè·¯å¾„
abandonment_path = paths.get('abandonment_nc')
world_shp = paths.get('world_shp')

print(f"Abandonment: {abandonment_path}")
print(f"World shapefile: {world_shp}")
```

### 5.3 åŠ è½½ PV æ•°æ®å¹¶å¯¹é½

```python
from landuse.data import load_pv_sites, load_all_ds, validate_data_alignment

# 1. åŠ è½½ PV ç«™ç‚¹
df_pv = load_pv_sites(
    "C:/Dev/Landuse_Zhong_clean/data/aligned_for_training0519.csv",
    years=[2018, 2020]
)

# 2. åŠ è½½ç‰¹å¾æ•°æ®
ds = load_all_ds()

# 3. éªŒè¯å¯¹é½
is_aligned = validate_data_alignment(df_pv, ds)

if is_aligned:
    print("âœ… Data is aligned!")
else:
    print("âŒ Alignment issues detected")
```

### 5.4 åŠ è½½å¤šåœºæ™¯ç»æµæ•°æ®

```python
from landuse.data import get_global_paths
import pandas as pd

paths = get_global_paths()

# åŠ è½½æ‰€æœ‰ NPV åœºæ™¯
scenarios = ['electrification', 'high_growth', 'low_growth', 
             'medium_electrification', 'reference', 'original']

npv_data = {}
for scenario in scenarios:
    path = paths.get_scenario_path(scenario)
    npv_data[scenario] = pd.read_csv(path)
    print(f"Loaded {scenario}: {len(npv_data[scenario])} rows")
```

### 5.5 Pipeline Stage ä½¿ç”¨æ¨¡å¼

```python
# Example: Stage 1 - Alignment
import sys
from pathlib import Path
import yaml

sys.path.insert(0, str(Path(__file__).parent.parent.parent / "src"))

from landuse.data import GlobalDataPaths, load_pv_sites, load_all_ds

def align_pv_data(config_path: str):
    # 1. Load config
    with open(config_path, 'r') as f:
        config = yaml.safe_load(f)
    
    paths = GlobalDataPaths(config)
    
    # 2. Load PV sites
    df_pv = load_pv_sites(paths.get('pv_sites_csv'))
    
    # 3. Load features
    ds_features = load_all_ds(paths)
    
    # 4. Align (simplified)
    # ... alignment logic ...
    
    # 5. Save
    output_path = paths.get('pv_embedding')
    df_aligned.to_csv(output_path, index=False)
    
    print(f"âœ… Aligned data saved to: {output_path}")

if __name__ == "__main__":
    align_pv_data("configs/global.yaml")
```

---

## 6. æ•°æ®éªŒè¯

### 6.1 éªŒè¯è„šæœ¬

**ä½ç½®**: `scripts/01_Feature_engineering.ipynb`

**æµ‹è¯•å†…å®¹**:
1. âœ… é…ç½®åŠ è½½
2. âœ… è·¯å¾„åˆå§‹åŒ–
3. âœ… Abandonment æ•°æ®åŠ è½½ï¼ˆNC + CSVï¼‰
4. âœ… Feature æ•°æ®åŠ è½½
5. âœ… PV ç«™ç‚¹åŠ è½½
6. âœ… å…¨çƒè¾¹ç•ŒåŠ è½½
7. âœ… æ•°æ®å¯¹é½éªŒè¯
8. âœ… ç©ºé—´åˆ†å¸ƒå¯è§†åŒ–
9. âœ… å˜é‡å®šä¹‰æ£€æŸ¥

**è¿è¡Œæ–¹å¼**:
```bash
cd scripts
jupyter notebook 01_Feature_engineering.ipynb
```

### 6.2 è‡ªåŠ¨åŒ–æµ‹è¯•

åˆ›å»ºæµ‹è¯•è„šæœ¬ `tests/test_data_interface.py`:

```python
import pytest
from landuse.data import (
    GlobalDataPaths,
    get_global_paths,
    load_all_ds,
    load_pv_sites,
    get_all_feature_variables,
)

def test_global_paths_initialization():
    """Test GlobalDataPaths initialization"""
    paths = GlobalDataPaths()
    assert paths is not None
    assert len(paths.list_all_paths()) > 0

def test_feature_variables():
    """Test feature variable definitions"""
    features = get_all_feature_variables()
    assert len(features) == 14  # 8 3D + 6 2D

def test_load_dataset():
    """Test dataset loading"""
    paths = get_global_paths()
    ds = load_all_ds(paths, chunks={'lat': 100, 'lon': 100, 'time': 1})
    
    assert 'lon' in ds.coords
    assert 'lat' in ds.coords
    assert 'time' in ds.coords
    
    # Check coordinate types
    assert ds.lon.dtype == 'float32'
    assert ds.lat.dtype == 'float32'

def test_path_consistency():
    """Test path consistency with original code"""
    paths = GlobalDataPaths()
    
    # Check critical paths exist
    assert paths.get('abandonment_nc') is not None
    assert paths.get('feature') is not None
    assert paths.get('world_shp') is not None
    
    # Check paths match expected patterns
    assert 'xarray' in paths.get('abandonment_nc').lower()
    assert 'feature' in paths.get('feature').lower()

if __name__ == "__main__":
    pytest.main([__file__, "-v"])
```

**è¿è¡Œæµ‹è¯•**:
```bash
pytest tests/test_data_interface.py -v
```

---

## ğŸ“Š Summary

### âœ… å®Œæˆçš„å·¥ä½œ

1. **ç»Ÿä¸€æ•°æ®è·¯å¾„ç®¡ç†**
   - âœ… åˆ›å»º `GlobalDataPaths` ç±»
   - âœ… å¯¹é½ `function/global_varibles.py`
   - âœ… é›†æˆåˆ° `configs/global.yaml`

2. **ç»Ÿä¸€æ•°æ®åŠ è½½æ¥å£**
   - âœ… åˆ›å»º `loaders.py` æ¨¡å—
   - âœ… å¯¹é½ `function/load_all_ds.py`
   - âœ… æ–°å¢ PV embedding åŠ è½½
   - âœ… æ–°å¢å…¨çƒè¾¹ç•ŒåŠ è½½

3. **æ•°æ®éªŒè¯**
   - âœ… åˆ›å»ºæµ‹è¯• notebook
   - âœ… æ•°æ®å¯¹é½éªŒè¯å‡½æ•°
   - âœ… è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶

4. **æ–‡æ¡£åŒ–**
   - âœ… æœ¬æ–‡æ¡£
   - âœ… æ•°æ®æµå‘å›¾
   - âœ… ä½¿ç”¨ç¤ºä¾‹

### ğŸ¯ å…³é”®å˜æ›´

| ç±»åˆ« | åŸä»£ç  | æ–°ä»£ç  | çŠ¶æ€ |
|------|--------|--------|------|
| è·¯å¾„ç®¡ç† | `function/global_varibles.py` | `src/landuse/data/global_paths.py` | âœ… å¯¹é½ |
| æ•°æ®åŠ è½½ | `function/load_all_ds.py` | `src/landuse/data/loaders.py` | âœ… å¯¹é½ |
| å…¨çƒçŸ¢é‡ | `PATHS['World_shp']` | `paths.get('world_shp')` | âœ… å¯¹é½ |
| Abandonment CSV | æ—  | `paths.get('abandonment_csv')` | âœ… æ–°å¢ |
| PV Embedding | æ‰‹åŠ¨ç”Ÿæˆ | `load_pv_embedding()` | âœ… æ–°å¢ |

### ğŸ“ ä¸‹ä¸€æ­¥

1. **è¿è¡ŒéªŒè¯æµ‹è¯•**
   ```bash
   jupyter notebook scripts/01_Feature_engineering.ipynb
   ```

2. **æ›´æ–° Pipeline Stages**
   - Stage 0: ä½¿ç”¨æ–°æ¥å£åŠ è½½æ•°æ®
   - Stage 1: ä½¿ç”¨æ–°æ¥å£ç”Ÿæˆ PV embedding

3. **è¿ç§»åŸæœ‰ä»£ç **
   - å°† `function/` ä¸­çš„ä»£ç é€æ­¥æ›¿æ¢ä¸ºæ–°æ¥å£
   - ä¿æŒå‘åå…¼å®¹

---

## ğŸ“§ Support

å¦‚æœ‰ç–‘é—®ï¼š
- **æ–‡æ¡£**: `docs/` ç›®å½•
- **æµ‹è¯•**: `scripts/01_Feature_engineering.ipynb`
- **ä»£ç **: `src/landuse/data/`

**ç‰ˆæœ¬å†å²**:
- 1.0.0 (2025-01-16): åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆæ•°æ®æ¥å£ç»Ÿä¸€

---

**æœ€åæ›´æ–°**: 2025-01-16  
**ç»´æŠ¤è€…**: Cursor Agent  
**çŠ¶æ€**: âœ… Production Ready
